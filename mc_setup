#!/usr/bin/env python3
"""Interactive setup helper for MegaContext training runs."""

from __future__ import annotations

import os
import shutil
import subprocess
from getpass import getpass
from pathlib import Path

REPO_ROOT = Path(__file__).resolve().parent
ENV_FILE = REPO_ROOT / ".mc_env"


def info(msg: str) -> None:
    print(f"[mc_setup] {msg}")


def run(cmd: list[str], **kwargs) -> None:
    info("$ " + " ".join(cmd))
    subprocess.run(cmd, check=True, **kwargs)


def ensure_uv() -> str:
    uv_path = shutil.which("uv")
    if uv_path:
        return uv_path
    info("uv not found; installing via curl | sh ...")
    install_cmd = "curl -LsSf https://astral.sh/uv/install.sh | sh"
    subprocess.run(["bash", "-lc", install_cmd], check=True)
    uv_path = shutil.which("uv")
    if uv_path:
        return uv_path
    # Fallback: look in ~/.cargo/bin and ~/.local/bin
    for candidate in (
        Path.home() / ".cargo/bin/uv",
        Path.home() / ".local/bin/uv",
    ):
        if candidate.exists():
            os.environ["PATH"] = f"{candidate.parent}:{os.environ['PATH']}"
            return str(candidate)
    raise RuntimeError("uv installation succeeded but executable not found on PATH")


def ensure_venv() -> None:
    if not (REPO_ROOT / ".venv").exists():
        run(["uv", "venv"])
    run(["uv", "sync", "--extra", "gpu"])
    # Ensure otel deps are present even if user reruns setup later
    run(["uv", "pip", "install", "opentelemetry-sdk", "opentelemetry-exporter-otlp"])


def prompt(text: str, default: str | None = None, secret: bool = False) -> str:
    prompt_text = f"{text}"
    if default:
        prompt_text += f" [{default}]"
    prompt_text += ": "
    if secret:
        value = getpass(prompt_text)
    else:
        value = input(prompt_text)
    if not value and default is not None:
        return default
    return value.strip()


def collect_env() -> dict[str, str]:
    info("Collecting environment settings (press Enter to accept defaults)...")
    env: dict[str, str] = {}
    wandb_key = prompt("WANDB_API_KEY (leave blank for dummy logging)", secret=True)
    if wandb_key:
        env["WANDB_API_KEY"] = wandb_key
    wandb_run = prompt("WANDB run name", "mc-run10")
    env["WANDB_RUN"] = wandb_run
    hf_token = prompt("HF_TOKEN (optional)", secret=True)
    if hf_token:
        env["HF_TOKEN"] = hf_token
    base_dir = prompt("NANOCHAT_BASE_DIR", str(Path.home() / ".cache/nanochat"))
    env["NANOCHAT_BASE_DIR"] = base_dir
    otel_endpoint = prompt("MC_OTEL_ENDPOINT (optional OTLP URL)")
    if otel_endpoint:
        env["MC_OTEL_ENDPOINT"] = otel_endpoint
        insecure = prompt("MC_OTEL_INSECURE? (y/n)", "n").lower() in {"y", "yes"}
        env["MC_OTEL_INSECURE"] = "1" if insecure else "0"
    return env


def write_env_file(env: dict[str, str]) -> None:
    lines = ["# Auto-generated by mc_setup. `source .mc_env` or let run10.sh load it."]
    for key, value in env.items():
        escaped = value.replace("\n", "\\n")
        lines.append(f"export {key}='{escaped}'")
    ENV_FILE.write_text("\n".join(lines) + "\n", encoding="utf-8")
    info(f"Wrote {ENV_FILE.relative_to(REPO_ROOT)}")


def main() -> None:
    if not (REPO_ROOT / "run10.sh").exists():
        raise SystemExit("Please run mc_setup from the repo root (run10.sh not found).")
    ensure_uv()
    ensure_venv()
    env = collect_env()
    write_env_file(env)
    info("Setup complete. Next steps:")
    info("  1) source .venv/bin/activate  # optional; run10.sh activates automatically")
    info("  2) Review .mc_env (edit if needed)")
    info("  3) Run: bash run10.sh --gpu 5090 --mc ...")


if __name__ == "__main__":
    main()
