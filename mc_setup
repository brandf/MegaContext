#!/usr/bin/env python3
"""Interactive setup helper for MegaContext training runs."""

from __future__ import annotations

import os
import shutil
import subprocess
from getpass import getpass
from pathlib import Path

REPO_ROOT = Path(__file__).resolve().parent
ENV_FILE = REPO_ROOT / ".mc_env"
PATH_PREFIXES: list[str] = []


def info(msg: str) -> None:
    print(f"[mc_setup] {msg}")


def run(cmd: list[str], **kwargs) -> None:
    info("$ " + " ".join(cmd))
    subprocess.run(cmd, check=True, **kwargs)


def _add_path_prefix(path: Path) -> None:
    prefix = str(path)
    current = os.environ.get("PATH", "")
    parts = current.split(os.pathsep) if current else []
    if prefix not in parts:
        os.environ["PATH"] = f"{prefix}{os.pathsep}{current}" if current else prefix
    if prefix not in PATH_PREFIXES:
        PATH_PREFIXES.append(prefix)


def ensure_uv() -> str:
    uv_path = shutil.which("uv")
    if uv_path:
        info(f"Using uv at {uv_path}")
        return uv_path
    info("uv not found; installing via curl | sh ...")
    install_cmd = "curl -LsSf https://astral.sh/uv/install.sh | sh"
    subprocess.run(["bash", "-lc", install_cmd], check=True)
    uv_path = shutil.which("uv")
    if uv_path:
        info(f"Using uv at {uv_path}")
        cargo_bin = str(Path.home() / ".cargo/bin")
        if uv_path.startswith(cargo_bin):
            info(f"If shells can't find uv, run: source \"{Path.home() / '.cargo/env'}\"")
        return uv_path
    # Fallback: look in ~/.cargo/bin and ~/.local/bin
    for candidate in (
        Path.home() / ".cargo/bin/uv",
        Path.home() / ".local/bin/uv",
    ):
        if candidate.exists():
            _add_path_prefix(candidate.parent)
            info(f"Using uv at {candidate}")
            if ".cargo/bin" in str(candidate.parent):
                info(f"If shells can't find uv, run: source \"{Path.home() / '.cargo/env'}\"")
            return str(candidate)
    raise RuntimeError("uv installation succeeded but executable not found on PATH")


def ensure_venv() -> None:
    if not (REPO_ROOT / ".venv").exists():
        run(["uv", "venv"])
    run(["uv", "sync", "--extra", "gpu"])
    # Ensure otel deps are present even if user reruns setup later
    run(["uv", "pip", "install", "opentelemetry-sdk", "opentelemetry-exporter-otlp"])
    run(["uv", "pip", "install", "-e", "."])


def prompt(
    text: str,
    default: str | None = None,
    secret: bool = False,
    allow_clear: bool = False,
) -> str:
    prompt_text = f"{text}"
    if default:
        if secret:
            suffix = " [Enter=keep"
            if allow_clear:
                suffix += ", type 'clear' to remove"
            suffix += "]"
            prompt_text += suffix
        else:
            prompt_text += f" [{default}]"
    prompt_text += ": "
    if secret:
        value = getpass(prompt_text)
    else:
        value = input(prompt_text)
    if allow_clear and value.strip().lower() == "clear":
        return ""
    if not value and default is not None:
        return default
    return value.strip()


def load_existing_env() -> dict[str, str]:
    if not ENV_FILE.exists():
        return {}
    env: dict[str, str] = {}
    for raw_line in ENV_FILE.read_text(encoding="utf-8").splitlines():
        line = raw_line.strip()
        if not line or line.startswith("#") or not line.startswith("export "):
            continue
        body = line[len("export ") :]
        if "=" not in body:
            continue
        key, value = body.split("=", 1)
        key = key.strip()
        value = value.strip()
        if value.startswith("'") and value.endswith("'"):
            value = value[1:-1]
        value = value.replace("\\n", "\n")
        env[key] = value
    return env


def collect_env(defaults: dict[str, str]) -> dict[str, str]:
    info("Collecting environment settings (press Enter to accept defaults)...")
    env: dict[str, str] = {}
    wandb_key = prompt(
        "WANDB_API_KEY (leave blank for dummy logging)",
        default=defaults.get("WANDB_API_KEY"),
        secret=True,
        allow_clear=True,
    )
    if wandb_key:
        env["WANDB_API_KEY"] = wandb_key
    wandb_run = prompt("WANDB run name", defaults.get("WANDB_RUN", "mc-run10"))
    env["WANDB_RUN"] = wandb_run
    hf_token = prompt(
        "HF_TOKEN (optional)",
        default=defaults.get("HF_TOKEN"),
        secret=True,
        allow_clear=True,
    )
    if hf_token:
        env["HF_TOKEN"] = hf_token
    base_dir = prompt(
        "NANOCHAT_BASE_DIR",
        defaults.get("NANOCHAT_BASE_DIR", str(Path.home() / ".cache/nanochat")),
    )
    env["NANOCHAT_BASE_DIR"] = base_dir
    otel_endpoint = prompt(
        "MC_OTEL_ENDPOINT (optional OTLP URL)",
        default=defaults.get("MC_OTEL_ENDPOINT"),
    )
    if otel_endpoint:
        env["MC_OTEL_ENDPOINT"] = otel_endpoint
        default_insecure = "y" if defaults.get("MC_OTEL_INSECURE") in {"1", "true", "yes"} else "n"
        insecure = prompt("MC_OTEL_INSECURE? (y/n)", default_insecure).lower() in {"y", "yes"}
        env["MC_OTEL_INSECURE"] = "1" if insecure else "0"
    skip_default = "y" if defaults.get("SKIP_DATA_PREP") == "1" else "n"
    skip_data_prep = prompt("Skip dataset/tokenizer prep in run10? (y/n)", skip_default).lower() in {"y", "yes"}
    env["SKIP_DATA_PREP"] = "1" if skip_data_prep else "0"
    return env


def write_env_file(env: dict[str, str], defaults: dict[str, str] | None = None) -> None:
    lines = ["# Auto-generated by mc_setup. `source .mc_env` or let run10.sh load it."]
    path_lines: list[str] = []
    if defaults:
        existing_path = defaults.get("PATH")
        if existing_path:
            path_lines.append(existing_path)
    for prefix in PATH_PREFIXES:
        expr = f"{prefix}:$PATH"
        if expr not in path_lines:
            path_lines.append(expr)
    for expr in path_lines:
        lines.append(f"export PATH='{expr}'")
    for key, value in env.items():
        escaped = value.replace("\n", "\\n")
        lines.append(f"export {key}='{escaped}'")
    ENV_FILE.write_text("\n".join(lines) + "\n", encoding="utf-8")
    info(f"Wrote {ENV_FILE.relative_to(REPO_ROOT)}")


def main() -> None:
    if not (REPO_ROOT / "run10.sh").exists():
        raise SystemExit("Please run mc_setup from the repo root (run10.sh not found).")
    ensure_uv()
    ensure_venv()
    defaults = load_existing_env()
    if defaults:
        info("Loaded existing .mc_env defaults.")
    env = collect_env(defaults)
    write_env_file(env, defaults)
    info("Setup complete. Next steps:")
    info("  1) source .venv/bin/activate  # optional; run10.sh activates automatically")
    info("  2) Review .mc_env (edit if needed)")
    info("  3) Run: bash run10.sh --gpu 5090 --mc ...")


if __name__ == "__main__":
    main()
